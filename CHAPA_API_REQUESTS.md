# Chapa API Requests - Complete Reference

This document shows the **EXACT** HTTP requests sent to Chapa API.

---

## 1. Initialize Payment (Create Checkout)

### HTTP Request Details

**Method:** `POST`

**URL:**
```
https://api.chapa.co/v1/transaction/initialize
```

**Headers:**
```http
Authorization: Bearer YOUR_CHAPA_SECRET_KEY
Content-Type: application/json
```

### Request Body (JSON)

```json
{
  "amount": "2304.00",
  "currency": "ETB",
  "email": "customer@example.com",
  "first_name": "John",
  "last_name": "Doe",
  "phone_number": "0911234567",
  "tx_ref": "tx-a1b2c3d4e5f6-f367ddf9-f2ff-4de2-b929-0e0942ace93b",
  "callback_url": "https://YOUR_DOMAIN.pythonanywhere.com/api/payments/verify/",
  "return_url": "https://YOUR_DOMAIN.pythonanywhere.com/bookings",
  "customization": {
    "title": "Booking Payment",
    "description": "Payment for Spacious Family Home in New York"
  }
}
```

### Field Explanations

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `amount` | string | Yes | Payment amount (e.g., "2304.00") |
| `currency` | string | Yes | Currency code (ETB for Ethiopian Birr) |
| `email` | string | Yes | Customer's email address |
| `first_name` | string | Yes | Customer's first name |
| `last_name` | string | Yes | Customer's last name |
| `phone_number` | string | No | Customer's phone number |
| `tx_ref` | string | Yes | Unique transaction reference (generated by your system) |
| `callback_url` | string | Yes | URL Chapa calls after payment |
| `return_url` | string | No | URL customer returns to after payment |
| `customization.title` | string | No | Payment page title (MAX 16 characters!) |
| `customization.description` | string | No | Payment description |

### Full cURL Example

```bash
curl -X POST https://api.chapa.co/v1/transaction/initialize \
  -H "Authorization: Bearer CHASECK_TEST-xxxxxxxxxxxxxxxxxx" \
  -H "Content-Type: application/json" \
  -d '{
    "amount": "2304.00",
    "currency": "ETB",
    "email": "customer@example.com",
    "first_name": "John",
    "last_name": "Doe",
    "phone_number": "0911234567",
    "tx_ref": "tx-a1b2c3d4e5f6-f367ddf9",
    "callback_url": "https://yourdomain.pythonanywhere.com/api/payments/verify/",
    "return_url": "https://yourdomain.pythonanywhere.com/bookings",
    "customization": {
      "title": "Payment for Booking f367ddf9",
      "description": "Payment for Spacious Family Home"
    }
  }'
```

### Python Requests Example

```python
import requests
import os

url = "https://api.chapa.co/v1/transaction/initialize"

headers = {
    "Authorization": f"Bearer {os.getenv('CHAPA_SECRET_KEY')}",
    "Content-Type": "application/json"
}

data = {
    "amount": "2304.00",
    "currency": "ETB",
    "email": "customer@example.com",
    "first_name": "John",
    "last_name": "Doe",
    "phone_number": "0911234567",
    "tx_ref": "tx-a1b2c3d4e5f6-f367ddf9",
    "callback_url": "https://yourdomain.pythonanywhere.com/api/payments/verify/",
    "return_url": "https://yourdomain.pythonanywhere.com/bookings",
    "customization": {
        "title": "Payment for Booking f367ddf9",
        "description": "Payment for Spacious Family Home"
    }
}

response = requests.post(url, json=data, headers=headers)
print(response.json())
```

### Expected Response from Chapa (Success)

```json
{
  "status": "success",
  "message": "Hosted Link",
  "data": {
    "checkout_url": "https://checkout.chapa.co/checkout/payment/AfjfjGjrGrj469"
  }
}
```

### Expected Response from Chapa (Error)

```json
{
  "status": "failed",
  "message": "Invalid API Key or the business can't accept payments at the moment. Please verify your API key and ensure the account is active and able to process payments."
}
```

---

## 2. Verify Payment

### HTTP Request Details

**Method:** `GET`

**URL:**
```
https://api.chapa.co/v1/transaction/verify/{tx_ref}
```

Example:
```
https://api.chapa.co/v1/transaction/verify/tx-a1b2c3d4e5f6-f367ddf9
```

**Headers:**
```http
Authorization: Bearer YOUR_CHAPA_SECRET_KEY
```

### No Request Body Required

This is a GET request, so no body is sent. The transaction reference is in the URL path.

### Full cURL Example

```bash
curl -X GET https://api.chapa.co/v1/transaction/verify/tx-a1b2c3d4e5f6-f367ddf9 \
  -H "Authorization: Bearer CHASECK_TEST-xxxxxxxxxxxxxxxxxx"
```

### Python Requests Example

```python
import requests
import os

tx_ref = "tx-a1b2c3d4e5f6-f367ddf9"
url = f"https://api.chapa.co/v1/transaction/verify/{tx_ref}"

headers = {
    "Authorization": f"Bearer {os.getenv('CHAPA_SECRET_KEY')}"
}

response = requests.get(url, headers=headers)
print(response.json())
```

### Expected Response from Chapa (Success)

```json
{
  "status": "success",
  "message": "Transaction verified successfully",
  "data": {
    "first_name": "John",
    "last_name": "Doe",
    "email": "customer@example.com",
    "currency": "ETB",
    "amount": "2304.00",
    "charge": "69.12",
    "mode": "test",
    "method": "card",
    "type": "API",
    "status": "success",
    "reference": "CHAPA-TX-1234567890",
    "tx_ref": "tx-a1b2c3d4e5f6-f367ddf9",
    "customization": {
      "title": "Payment for Booking f367ddf9",
      "description": "Payment for Spacious Family Home"
    },
    "meta": null,
    "created_at": "2025-11-13T21:12:56.000000Z",
    "updated_at": "2025-11-13T21:15:23.000000Z"
  }
}
```

### Expected Response from Chapa (Failed Payment)

```json
{
  "status": "failed",
  "message": "Transaction failed or cancelled",
  "data": {
    "status": "failed",
    "tx_ref": "tx-a1b2c3d4e5f6-f367ddf9"
  }
}
```

---

## 3. Complete Flow Example

### Step-by-Step HTTP Requests

#### Step 1: Your Frontend â†’ Your Backend

```http
POST /api/payments/initiate/ HTTP/1.1
Host: yourdomain.pythonanywhere.com
Content-Type: application/json

{
  "booking_id": "f367ddf9-f2ff-4de2-b929-0e0942ace93b",
  "email": "customer@example.com",
  "first_name": "John",
  "last_name": "Doe",
  "phone_number": "0911234567"
}
```

#### Step 2: Your Backend â†’ Chapa API

```http
POST /v1/transaction/initialize HTTP/1.1
Host: api.chapa.co
Authorization: Bearer CHASECK_TEST-xxxxxxxxxxxxxxxxxx
Content-Type: application/json

{
  "amount": "2304.00",
  "currency": "ETB",
  "email": "customer@example.com",
  "first_name": "John",
  "last_name": "Doe",
  "phone_number": "0911234567",
  "tx_ref": "tx-a1b2c3d4e5f6-f367ddf9",
  "callback_url": "https://yourdomain.pythonanywhere.com/api/payments/verify/",
  "return_url": "https://yourdomain.pythonanywhere.com/bookings",
  "customization": {
    "title": "Payment for Booking f367ddf9",
    "description": "Payment for Spacious Family Home"
  }
}
```

#### Step 3: Chapa API â†’ Your Backend (Response)

```http
HTTP/1.1 200 OK
Content-Type: application/json

{
  "status": "success",
  "message": "Hosted Link",
  "data": {
    "checkout_url": "https://checkout.chapa.co/checkout/payment/AfjfjGjrGrj469"
  }
}
```

#### Step 4: Customer Pays on Chapa

Customer redirects to checkout_url and completes payment.

#### Step 5: Chapa â†’ Your Backend (Callback)

```http
GET /api/payments/verify/?tx_ref=tx-a1b2c3d4e5f6-f367ddf9&status=success HTTP/1.1
Host: yourdomain.pythonanywhere.com
```

#### Step 6: Your Backend â†’ Chapa API (Verification)

```http
GET /v1/transaction/verify/tx-a1b2c3d4e5f6-f367ddf9 HTTP/1.1
Host: api.chapa.co
Authorization: Bearer CHASECK_TEST-xxxxxxxxxxxxxxxxxx
```

#### Step 7: Chapa API â†’ Your Backend (Verification Response)

```http
HTTP/1.1 200 OK
Content-Type: application/json

{
  "status": "success",
  "message": "Transaction verified successfully",
  "data": {
    "status": "success",
    "amount": "2304.00",
    "currency": "ETB",
    "tx_ref": "tx-a1b2c3d4e5f6-f367ddf9",
    "reference": "CHAPA-TX-1234567890",
    ...
  }
}
```

---

## 4. Code Implementation

### Where These Requests Are Made

**File:** `listings/views.py`

**Initialize Payment Function:**
```python
# Line 198-204
chapa_url = f"{os.getenv('CHAPA_BASE_URL', 'https://api.chapa.co/v1')}/transaction/initialize"
headers = {
    "Authorization": f"Bearer {os.getenv('CHAPA_SECRET_KEY')}",
    "Content-Type": "application/json"
}

response = requests.post(chapa_url, json=chapa_data, headers=headers)
```

**Verify Payment Function:**
```python
# Line 314-319
chapa_url = f"{os.getenv('CHAPA_BASE_URL', 'https://api.chapa.co/v1')}/transaction/verify/{tx_ref}"
headers = {
    "Authorization": f"Bearer {os.getenv('CHAPA_SECRET_KEY')}"
}

response = requests.get(chapa_url, headers=headers)
```

---

## 5. Environment Variables Required

```bash
# .env file
CHAPA_SECRET_KEY=CHASECK_TEST-xxxxxxxxxxxxxxxxxx
CHAPA_PUBLIC_KEY=CHAPUBK_TEST-xxxxxxxxxxxxxxxxxx
CHAPA_BASE_URL=https://api.chapa.co/v1
CHAPA_CALLBACK_URL=https://YOUR_DOMAIN.pythonanywhere.com/api/payments/verify/
```

---

## 6. Testing with Real Chapa API

### Get Test API Keys

1. Sign up at https://dashboard.chapa.co/
2. Go to **Settings** â†’ **API Keys**
3. Copy **Test Secret Key** (starts with `CHASECK_TEST-`)
4. Copy **Test Public Key** (starts with `CHAPUBK_TEST-`)

### Test Payment

Use test card numbers from Chapa:
- **Success:** 4000 0000 0000 0002
- **Decline:** 4000 0000 0000 0069
- **CVV:** Any 3 digits
- **Expiry:** Any future date

---

## 7. Production vs Test

### Test Mode
- API Key: `CHASECK_TEST-xxxxx`
- Base URL: `https://api.chapa.co/v1`
- Use test card numbers

### Production Mode
- API Key: `CHASECK-xxxxx` (no TEST)
- Base URL: `https://api.chapa.co/v1` (same)
- Use real card numbers

---

## Summary

### Two API Calls to Chapa:

1. **POST** `/transaction/initialize` - Create checkout
   - Sends: amount, email, customer details
   - Returns: checkout_url

2. **GET** `/transaction/verify/{tx_ref}` - Verify payment
   - Sends: nothing (GET request)
   - Returns: payment status and details

### Both Use Same Authentication:
```http
Authorization: Bearer YOUR_CHAPA_SECRET_KEY
```

**That's it! Simple and straightforward!** ðŸš€
